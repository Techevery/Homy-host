generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
 Admin 
 Super_Admin
}

model Admin {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique
  password     String
  address      String
  gender       String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  phone_number String      @unique @default("08080000000")
  apartments   Apartment[] @relation("AdminApartments")
  role         Role?

  @@map("admins")
}

model Agent {
  id                  String              @id @default(uuid())
  name                String
  email               String              @unique
  address             String
  password            String
  phone_number        String              @unique
  bank_name           String
  account_number      String              @unique
  gender              String
  status              AgentStatus         @default(UNVERIFIED)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  profile_picture     String?
  id_card             String?
  slug                String              @unique
  personalUrl         String
  accountBalance      Int?                @default(0)
  nextOfKinAddress    String?
  nextOfKinEmail      String?
  nextOfKinName       String?
  nextOfKinOccupation String?
  nextOfKinPhone      String?
  nextOfKinStatus     String?
  suspended           Boolean             @default(false)
  payout              Payout[]
  Wallet              Wallet[]
  AgentBanner         AgentBanner[]
  AgentListing        AgentListing[]
  apartmentLog        ApartmentLog[]
  FailedTransaction   FailedTransaction[]
  Transaction         Transaction[]
  apartment           Apartment[]         @relation("AgentApartments")
  forgetPassword      ForgetPassword?

  @@map("agents")
}

model Apartment {
  id                String              @id @default(uuid())
  name              String
  address           String
  type              String
  servicing         String
  bedroom           String
  price             Int
  images            String[]            @default([])
  adminId           String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  video_link        String?
  agentPercentage   Int?
  amenities         String?
  location          String?
  isBooked          Boolean             @default(false)
  AgentListing      AgentListing[]
  createdBy         Admin               @relation("AdminApartments", fields: [adminId], references: [id])
  ApartmentLog      ApartmentLog[]
  bookingPeriods    BookingPeriod[]
  FailedTransaction FailedTransaction[]
  Transaction       Transaction[]
  agents            Agent[]             @relation("AgentApartments")

  @@map("apartment")
}

model Transaction {
  id                 String           @id @default(uuid())
  email              String
  status             String
  amount             Int
  channel            String?
  charge             Int?
  metadata           Json?
  reference          String           @unique
  date_paid          DateTime?
  apartment_id       String
  agent_id           String
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  booking_end_date   DateTime?
  booking_start_date DateTime?
  duration_days      Int
  phone_number       String?
  payment_month      Decimal?
  payment_year       Int?
  credited           Boolean          @default(false)
  agentPercentage    Int?
  mockupPrice        Int?
  payout             Payout[]
  ApartmentLog       ApartmentLog[]
  bookingPeriods     BookingPeriod[]
  TransactionLog     TransactionLog[]
  agent              Agent            @relation(fields: [agent_id], references: [id])
  apartment          Apartment        @relation(fields: [apartment_id], references: [id])

  @@index([status], map: "status_idx")
  @@index([agent_id], map: "agent_idx")
  @@index([apartment_id], map: "apartment_log_apartment_idx")
  @@index([payment_month, payment_year], map: "date_idx")
  @@map("transactions")
}

model Banner {
  id          String   @id @default(uuid())
  image_url   String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  description String?
  name        String
}

model AgentBanner {
  id          String   @id @default(uuid())
  name        String
  description String?
  agentId     String
  image_url   String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  agent       Agent    @relation(fields: [agentId], references: [id])

  @@index([agentId], map: "agent_banner_agent_idx")
  @@map("agent_banners")
}

model TransactionLog {
  id             String      @id @default(uuid())
  transaction_id String
  action         String
  changed_by     String?
  old_values     Json?
  new_values     Json?
  created_at     DateTime    @default(now())
  transaction    Transaction @relation(fields: [transaction_id], references: [id])

  @@index([transaction_id], map: "apartment_log_transaction_idx")
  @@map("transaction_logs")
}

model BookingPeriod {
  id                 String           @id @default(uuid())
  transaction_id     String
  apartment_id       String
  start_date         DateTime
  end_date           DateTime
  duration_days      Int
  created_at         DateTime         @default(now())
  isDeleted          Boolean          @default(false)
  isEdited           Boolean          @default(false)
  expired            Boolean          @default(false)
  status             BookingStatus    @default(pending)
  newBookingDuration Int?
  apartment_logs     ApartmentLog[]
  apartment          Apartment        @relation(fields: [apartment_id], references: [id])
  transaction        Transaction      @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  deleted_bookings   DeletedBooking[]

  @@index([transaction_id])
  @@index([apartment_id])
  @@index([start_date, end_date])
  @@map("booking_periods")
}

model Charges {
  id          String        @id @default(uuid())
  description String
  amount      Int
  status      ChargesStatus @default(inactive)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  @@index([status])
  @@map("charges")
}

model DeletedBooking {
  id                String        @id @default(uuid())
  booking_period_id String
  deleted_at        DateTime      @default(now())
  booking_period    BookingPeriod @relation(fields: [booking_period_id], references: [id])
  created_at        DateTime      @default(now())

  @@index([booking_period_id])
  @@map("deleted_bookings")
}

model ApartmentLog {
  id                String         @id @default(uuid())
  apartment_id      String
  transaction_id    String
  availability      Boolean
  status            String
  created_at        DateTime       @default(now())
  booking_period_id String?
  agentId           String?
  agent             Agent?         @relation(fields: [agentId], references: [id])
  apartment         Apartment      @relation(fields: [apartment_id], references: [id])
  booking_period    BookingPeriod? @relation(fields: [booking_period_id], references: [id])
  transaction       Transaction    @relation(fields: [transaction_id], references: [id])

  @@index([apartment_id])
  @@index([transaction_id])
  @@index([booking_period_id])
  @@map("apartment_logs")
}

model AgentListing {
  id                       String    @id @default(uuid())
  agent_id                 String
  apartment_id             String
  base_price               Int
  markedup_price           Int?
  price_changed_by         String?
  price_changed_at         DateTime  @default(now())
  updated_at               DateTime  @updatedAt
  agent_commission_percent Int?
  agent                    Agent     @relation(fields: [agent_id], references: [id])
  apartment                Apartment @relation(fields: [apartment_id], references: [id])

  @@unique([agent_id, apartment_id], name: "unique_Agent_apartment")
  @@map("agent_listings")
}

model FailedTransaction {
  id             String    @id @default(uuid())
  email          String
  phone_number   String
  amount         String
  channel        String
  charge         String
  metadata       String
  reference      String    @unique
  failure_reason String?
  error_code     String?
  attempted_at   DateTime  @default(now())
  payment_month  Decimal
  payment_year   Int
  apartment_id   String
  agent_id       String
  agent          Agent     @relation(fields: [agent_id], references: [id])
  apartment      Apartment @relation(fields: [apartment_id], references: [id])

  @@index([reference], map: "failed_tx_ref_idx")
  @@index([agent_id], map: "failed_agent_idx")
  @@index([apartment_id], map: "failed_apartment_idx")
  @@index([payment_month, payment_year], map: "failed_date_idx")
  @@map("failed_transactions")
}

model Wallet {
  id        String   @id @default(uuid())
  agentId   String
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  agent     Agent    @relation(fields: [agentId], references: [id])
}

model ForgetPassword {
  id        String   @id @default(uuid())
  agentId   String   @unique
  token     String   @unique
  createdAt DateTime @default(now())
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([token])
}

model Payout {
  id            String       @id @default(uuid())
  agentId       String
  accountNumber String
  accountName   String
  bankName      String
  status        PayoutStatus @default(pending)
  createdAt     DateTime     @default(now())
  amount        Float
  proof         String?
  reference     String
  remark        String?
  transactionId String
  reason        String?
  charges       Int?
  agent         Agent        @relation(fields: [agentId], references: [id])
  transaction   Transaction  @relation(fields: [transactionId], references: [id])

  @@index([id, status, reference])
}

enum AgentStatus {
  VERIFIED
  UNVERIFIED
}

enum PayoutStatus {
  pending
  rejected
  success
}

enum ChargesStatus {
  active
  inactive
}

enum BookingStatus {
  booked 
  pending
  expired
}
